
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.4">
    
    
      
        <title>X3 Spotify Copy1 - Data Science Foundations</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bb3983ee.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../extra.css">
    
      <link rel="stylesheet" href="../../styles.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-114664473-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#what-makes-a-playlist-successful" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Data Science Foundations" class="md-header__button md-logo" aria-label="Data Science Foundations" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Data Science Foundations
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              X3 Spotify Copy1
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Data Science Foundations" class="md-nav__button md-logo" aria-label="Data Science Foundations" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Data Science Foundations
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Sessions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Sessions" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Sessions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../S1_Regression_and_Analysis/" class="md-nav__link">
        Regression and Analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../S2_Inferential_Statistics/" class="md-nav__link">
        Inferential Statistics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../S3_Model_Selection_and_Validation/" class="md-nav__link">
        Model Selection and Validation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../S4_Feature_Engineering/" class="md-nav__link">
        Feature Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../S5_Unsupervised_Learning/" class="md-nav__link">
        Unsupervised Learning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../S6_Bagging/" class="md-nav__link">
        Bagging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../S7_Boosting/" class="md-nav__link">
        Boosting
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Labs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Labs" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../labs/L1_Descriptive_Statistics_Data_Hunt/" class="md-nav__link">
        Descriptive Statistics Data Hunt
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../labs/L2_Inferential_Statistics_Data_Hunt/" class="md-nav__link">
        Inferential Statistics Data Hunt
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../labs/L3_Feature_Engineering/" class="md-nav__link">
        Practice with Feature Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../labs/L4_Supervised_Learners/" class="md-nav__link">
        Practice with Supervised Learners
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../labs/L5_Writing_Unit_Tests/" class="md-nav__link">
        Practice with Writing Unit Tests
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Project
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Project" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Project
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../project/P1_Statistical_Analysis_of_TicTacToe/" class="md-nav__link">
        Statistical Analysis of TicTacToe
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../project/P2_Heuristical_TicTacToe_Agents/" class="md-nav__link">
        Heuristical TicTacToe Agents
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../project/P3_1_Step_Look_Ahead_Agents/" class="md-nav__link">
        1-Step Look Ahead Agents
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../project/P4_N_Step_Look_Ahead_Agents/" class="md-nav__link">
        N-Step Look Ahead Agents
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Extras
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Extras" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Extras
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../X1_Bayesian_Probability/" class="md-nav__link">
        Probability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../X2_Airbnb/" class="md-nav__link">
        Airbnb
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../X3_AB_Testing/" class="md-nav__link">
        AB Tests
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../X4_Spotify_Appendix/" class="md-nav__link">
        Spotify
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-makes-a-playlist-successful" class="md-nav__link">
    What makes a playlist successful?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    Imports
  </a>
  
    <nav class="md-nav" aria-label="Imports">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#putting-it-all-together" class="md-nav__link">
    Putting it All Together
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#models-multi-feature-analysis" class="md-nav__link">
    Models (Multi-Feature Analysis)
  </a>
  
    <nav class="md-nav" aria-label="Models (Multi-Feature Analysis)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deciles-random-forest" class="md-nav__link">
    Deciles - Random Forest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quartiles-random-forest" class="md-nav__link">
    Quartiles - Random Forest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#binary-90th-percentile-random-forest" class="md-nav__link">
    Binary, 90th Percentile, Random Forest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forward-selection-model" class="md-nav__link">
    Forward Selection Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#binary-99th-percentile" class="md-nav__link">
    Binary, 99th Percentile
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other-metrics" class="md-nav__link">
    Other Metrics
  </a>
  
    <nav class="md-nav" aria-label="Other Metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#listen-and-user-conversions-mau-growing" class="md-nav__link">
    Listen and User Conversions, MAU Growing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#considering-outliers" class="md-nav__link">
    Considering outliers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-criteria-for-success" class="md-nav__link">
    Multiple Criteria for Success
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dependency" class="md-nav__link">
    Dependency
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusions" class="md-nav__link">
    Conclusions
  </a>
  
    <nav class="md-nav" aria-label="Conclusions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#discrete-independent-variables" class="md-nav__link">
    Discrete, Independent Variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#continuous-independent-variables" class="md-nav__link">
    Continuous, Independent Variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#discrete-dependent-variables" class="md-nav__link">
    Discrete, Dependent Variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dependency_1" class="md-nav__link">
    Dependency
  </a>
  
    <nav class="md-nav" aria-label="Dependency">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chi-square" class="md-nav__link">
    Chi Square
  </a>
  
    <nav class="md-nav" aria-label="Chi Square">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-the-most-influential-primary-genre-on-monthly-streams-over-30-seconds" class="md-nav__link">
    What is the most influential primary genre on monthly streams over 30 seconds?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-the-most-influential-primary-mood-on-monthly-streams-over-30-seconds" class="md-nav__link">
    What is the most influential primary mood on monthly streams over 30 seconds?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#which-categorical-feature-is-most-influential-overall" class="md-nav__link">
    Which Categorical Feature is most influential overall?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-are-the-shortcomings-of-this-analysis" class="md-nav__link">
    What are the shortcomings of this analysis?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#t-test" class="md-nav__link">
    t-Test
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    Models
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

  <h1>X3 Spotify Copy1</h1>

<h2 id="what-makes-a-playlist-successful">What makes a playlist successful?<a class="headerlink" href="#what-makes-a-playlist-successful" title="Permanent link">&para;</a></h2>
<p><strong>Analysis</strong></p>
<ul>
<li>Simple metric (dependent variable)<ul>
<li>mau</li>
<li>mau_previous_month</li>
<li>mau_both_months</li>
<li>monthly_stream30s</li>
<li>stream30s</li>
</ul>
</li>
<li>Design metric (dependent variable)<ul>
<li>30s listens/tot listens (listen conversions)</li>
<li>Users both months/users prev month (user conversions)</li>
<li>Best small time performers (less than X total monthly listens + high conversion)</li>
<li>Best new user playlist (owner has only 1 popular playlist)</li>
</ul>
</li>
<li>Define "top"<ul>
<li>Top 10%<ul>
<li>mau_previous_month: 9.0</li>
<li>mau_both_months: 2.0</li>
<li>mau: 9.0</li>
<li>monthly_stream30s: 432.0</li>
<li>stream30s: 17.0</li>
</ul>
</li>
<li>Top 1%<ul>
<li>mau_previous_month: 130.0</li>
<li>mau_both_months: 19.0</li>
<li>mau: 143.0</li>
<li>monthly_stream30s: 2843.0</li>
<li>stream30s: 113.0</li>
</ul>
</li>
</ul>
</li>
<li>Independent variables<ul>
<li>moods and genres (categorical)</li>
<li>number of tracks, albums, artists, and local tracks (continuous)</li>
</ul>
</li>
</ul>
<p>The analysis will consist of:</p>
<ol>
<li>understand the distribution characteristics of the dependent and independent variables</li>
<li>quantify the dependency of the dependent/independent variables for each of the simple and design metrics<ol>
<li>chi-square test</li>
<li>bootstrap/t-test</li>
</ol>
</li>
</ol>
<p><strong>Key Conclusions</strong></p>
<p>for the simple metrics, key genres and moods were <strong>Romantic, Latin, Children's, Lively, Traditional, and Jazz</strong>. Playlists that included these genres/moods had a positive multiplier effect (usually in the vicinicty of 2x more likely) on the key simple metric (i.e. playlists with latin as a primary genre were 2.5x more likely to be in the top 10% of streams longer than 30 seconds)</p>
<p>skippers - is this associated with the current playlist </p>
<table>
<thead>
<tr>
<th>Column Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>playlist_uri</td>
<td>The key, Spotify uri of the playlist</td>
</tr>
<tr>
<td>owner</td>
<td>Playlist owner, Spotify username</td>
</tr>
<tr>
<td>streams</td>
<td>Number of streams from the playlist today</td>
</tr>
<tr>
<td>stream30s</td>
<td>Number of streams over 30 seconds from playlist today</td>
</tr>
<tr>
<td>dau</td>
<td>Number of Daily Active Users, i.e. users with a stream over 30 seconds from playlist today</td>
</tr>
<tr>
<td>wau</td>
<td>Number of Weekly Active Users, i.e. users with a stream over 30 seconds from playlist in past week</td>
</tr>
<tr>
<td>mau</td>
<td>Number of Monthly Active Users, i.e. users with a stream over 30 seconds from playlist in the past month</td>
</tr>
<tr>
<td>mau_previous_months</td>
<td>Number of Monthly Active users in the month prior to this one</td>
</tr>
<tr>
<td>mau_both_months</td>
<td>Number of users that were active on the playlist both this and the previous month</td>
</tr>
<tr>
<td>users</td>
<td>Number of users streaming (all streams) from this playlist this month</td>
</tr>
<tr>
<td>skippers</td>
<td>Number of users who skipped more than 90 percent of their streams today</td>
</tr>
<tr>
<td>owner_country</td>
<td>Country of the playlist owner</td>
</tr>
<tr>
<td>n_tracks</td>
<td>Number of tracks in playlist</td>
</tr>
<tr>
<td>n_local_tracks</td>
<td>Change in number of tracks on playlist since yesterday</td>
</tr>
<tr>
<td>n_artists</td>
<td>Number of unique artists in playlist</td>
</tr>
<tr>
<td>n_albums</td>
<td>Number of unique albums in playlist</td>
</tr>
<tr>
<td>monthly_stream30s</td>
<td>Number of streams over 30 seconds this month</td>
</tr>
<tr>
<td>monthly_owner_stream30s</td>
<td>Number of streams over 30 seconds by playlist owner this month</td>
</tr>
<tr>
<td>tokens</td>
<td>List of playlist title tokens, stopwords and punctuation removed</td>
</tr>
<tr>
<td>genre_1</td>
<td>No. 1 Genre by weight of playlist tracks, from Gracenote metadata</td>
</tr>
<tr>
<td>genre_2</td>
<td>No. 2 Genre by weight of playlist tracks, from Gracenote metadata</td>
</tr>
<tr>
<td>genre_3</td>
<td>No. 3 Genre by weight of playlist tracks, from Gracenote metadata</td>
</tr>
<tr>
<td>mood_1</td>
<td>No. 1 Mood by weight of playlist tracks, from Gracenote metadata</td>
</tr>
<tr>
<td>mood_2</td>
<td>No. 2 Mood by weight of playlist tracks, from Gracenote metadata</td>
</tr>
<tr>
<td>mood_3</td>
<td>No. 3 Mood by weight of playlist tracks, from Gracenote metadata</td>
</tr>
</tbody>
</table>
<h2 id="imports">Imports<a class="headerlink" href="#imports" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># basic packages</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="c1"># visualization packages</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span><span class="p">;</span> <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">graphviz</span> 

<span class="c1"># stats packages</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.formula.api</span> <span class="kn">import</span> <span class="n">ols</span>
<span class="kn">from</span> <span class="nn">statsmodels.discrete.discrete_model</span> <span class="kn">import</span> <span class="n">Logit</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>

<span class="c1"># sklearn preprocessing</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">PolynomialFeatures</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.class_weight</span> <span class="kn">import</span> <span class="n">compute_class_weight</span>

<span class="c1"># sklearn modeling</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">RandomForestRegressor</span><span class="p">,</span> <span class="n">AdaBoostClassifier</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span><span class="p">,</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.mixture</span> <span class="kn">import</span> <span class="n">GaussianMixture</span>

<span class="c1"># sklearn evaluation</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">cross_val_score</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../../data/playlist_summary_external-4.txt&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>

<h4 id="putting-it-all-together">Putting it All Together<a class="headerlink" href="#putting-it-all-together" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="n">sub_targets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mau_previous_month&#39;</span><span class="p">,</span> <span class="s1">&#39;mau_both_months&#39;</span><span class="p">,</span> <span class="s1">&#39;monthly_stream30s&#39;</span><span class="p">,</span> <span class="s1">&#39;stream30s&#39;</span><span class="p">]</span>
<span class="n">des_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mood_1&#39;</span><span class="p">,</span> <span class="s1">&#39;mood_2&#39;</span><span class="p">,</span> <span class="s1">&#39;mood_3&#39;</span><span class="p">,</span> <span class="s1">&#39;genre_1&#39;</span><span class="p">,</span> <span class="s1">&#39;genre_2&#39;</span><span class="p">,</span> <span class="s1">&#39;genre_3&#39;</span><span class="p">]</span>
</code></pre></div>

<h4 id="models-multi-feature-analysis">Models (Multi-Feature Analysis)<a class="headerlink" href="#models-multi-feature-analysis" title="Permanent link">&para;</a></h4>
<h5 id="deciles-random-forest">Deciles - Random Forest<a class="headerlink" href="#deciles-random-forest" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="n">sub_targets</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">target</span> <span class="o">=</span> <span class="n">sub_targets</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">quant</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">11</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
        <span class="k">continue</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;less than </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> listens&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">labels</span><span class="p">[(</span><span class="n">labels</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">))</span>
              <span class="o">&amp;</span><span class="p">(</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">))]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> &lt; listens &lt;= </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">labels</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">names</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">des_features</span> <span class="o">+</span> <span class="n">con_features</span><span class="p">]</span>
<span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>

<span class="n">X_cat</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">des_features</span><span class="p">])</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="n">X_con</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">con_features</span><span class="p">])</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X_con</span><span class="p">,</span> <span class="n">X_cat</span><span class="p">))</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">y_hat_test</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Acc: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test Acc: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># grab feature importances</span>
<span class="n">imp</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>

<span class="c1"># their std</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">feature_importances_</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># build feature names</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">con_features</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">())</span>

<span class="c1"># create new dataframe</span>
<span class="n">feat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">imp</span><span class="p">,</span> <span class="n">std</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
<span class="n">feat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]</span>
<span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">feat</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">feat</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div>

<h5 id="quartiles-random-forest">Quartiles - Random Forest<a class="headerlink" href="#quartiles-random-forest" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="c1">### Create Categories</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">lim</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">quant</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">lim</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
        <span class="k">continue</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;less than </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> listens&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">labels</span><span class="p">[(</span><span class="n">labels</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">))</span>
              <span class="o">&amp;</span><span class="p">(</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">))]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> &lt; listens &lt;= </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">labels</span>

<span class="c1">### Create Training Data</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">des_features</span> <span class="o">+</span> <span class="n">con_features</span><span class="p">]</span>
<span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>

<span class="n">X_cat</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">des_features</span><span class="p">])</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="n">X_con</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">con_features</span><span class="p">])</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X_con</span><span class="p">,</span> <span class="n">X_cat</span><span class="p">))</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="c1">### Train Model</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1">### Asses Performance</span>

<span class="n">y_hat_test</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_hat_train</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Acc: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_hat_train</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test Acc: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>

<h5 id="binary-90th-percentile-random-forest">Binary, 90<sup>th</sup> Percentile, Random Forest<a class="headerlink" href="#binary-90th-percentile-random-forest" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="c1">### Create Categories</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">weights</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
<span class="n">lim</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">dom_class_weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">lim</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">quant</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">lim</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">lim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
        <span class="k">continue</span>
    <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">lim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dom_class_weight</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;less than </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> listens&quot;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">labels</span><span class="p">[(</span><span class="n">labels</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">))</span>
              <span class="o">&amp;</span><span class="p">(</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">))]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">weights</span><span class="p">[(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">))</span>
              <span class="o">&amp;</span><span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">))]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> &lt; listens &lt;= </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

    <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">labels</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">### Create Training Data</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">des_features</span> <span class="o">+</span> <span class="n">con_features</span><span class="p">]</span>
<span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>

<span class="n">X_cat</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">des_features</span><span class="p">])</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="n">X_con</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">con_features</span><span class="p">])</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X_con</span><span class="p">,</span> <span class="n">X_cat</span><span class="p">))</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">weight_train</span><span class="p">,</span> <span class="n">weight_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>


<span class="c1">### Strateification Code</span>

<span class="c1"># strat_y0_idx = np.array(random.sample(list(np.argwhere(y_train==3).reshape(-1)), np.unique(y_train, return_counts=True)[1][1]))</span>
<span class="c1"># strat_y1_idx = np.argwhere(y_train==4).reshape(-1)</span>
<span class="c1"># strat_idx = np.hstack((strat_y0_idx, strat_y1_idx))</span>
<span class="c1"># X_train = X_train[strat_idx]</span>
<span class="c1"># y_train = y_train[strat_idx]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">### Train Model</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1">### Assess Performance</span>

<span class="n">y_hat_test</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_hat_train</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Acc: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_hat_train</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test Acc: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>

<h5 id="forward-selection-model">Forward Selection Model<a class="headerlink" href="#forward-selection-model" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="c1">### y</span>
<span class="nb">print</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">weights</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
<span class="n">lim</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">dom_class_weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">lim</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">quant</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">lim</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">lim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
        <span class="k">continue</span>
    <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">lim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dom_class_weight</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;less than </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> listens&quot;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">labels</span><span class="p">[(</span><span class="n">labels</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">))</span>
              <span class="o">&amp;</span> <span class="p">(</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">weights</span><span class="p">[(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">))</span>
              <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">))]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> &lt; listens &lt;= </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">labels</span>

<span class="c1">#### X</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">des_features</span> <span class="o">+</span> <span class="n">con_features</span><span class="p">]</span>

<span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>

<span class="n">X_cat</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">des_features</span><span class="p">])</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="n">X_con</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">con_features</span><span class="p">])</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">X_con</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">X_con</span><span class="p">,</span> <span class="n">X_cat</span><span class="p">))</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">con_features</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">())</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">add_feature</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">basemodel</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r2max</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">feature_max</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bestsum</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">newmodel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">:</span>
        <span class="n">basemodel</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
        <span class="n">X2</span> <span class="o">=</span> <span class="n">basemodel</span><span class="o">.</span><span class="n">values</span>
        <span class="n">est</span> <span class="o">=</span> <span class="n">Logit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X2</span><span class="p">)</span>
        <span class="n">est2</span> <span class="o">=</span> <span class="n">est</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">summ</span> <span class="o">=</span> <span class="n">est2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summ</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">score</span> <span class="o">&gt;</span> <span class="n">r2max</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">est2</span><span class="o">.</span><span class="n">pvalues</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">r2max</span> <span class="o">=</span> <span class="n">score</span>
            <span class="n">feature_max</span> <span class="o">=</span> <span class="n">feature</span>
            <span class="n">bestsum</span> <span class="o">=</span> <span class="n">est2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
            <span class="n">newmodel</span> <span class="o">=</span> <span class="n">basemodel</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">disp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new r2max, </span><span class="si">{</span><span class="n">feature_max</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">r2max</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">basemodel</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span> <span class="o">=</span> <span class="n">feature</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r2max</span><span class="p">,</span> <span class="n">feature_max</span><span class="p">,</span> <span class="n">bestsum</span><span class="p">,</span> <span class="n">newmodel</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">candidates</span> <span class="o">=</span> <span class="n">feature_names</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">basemodel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">r2max</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;canidates.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">file_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">basemodel</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;basemodel.csv&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;canidates.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="c1"># file_data = f.read()</span>
    <span class="n">new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">current_place</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_place</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;basemodel.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;fwd_selection_results.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">lastline</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">stuff</span> <span class="o">=</span> <span class="n">lastline</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stuff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">new</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">newr2max</span><span class="p">,</span> <span class="n">feature_max</span><span class="p">,</span> <span class="n">bestsum</span><span class="p">,</span> <span class="n">newmodel</span> <span class="o">=</span> <span class="n">add_feature</span><span class="p">(</span>
        <span class="n">feature_names</span><span class="o">=</span><span class="n">candidates</span><span class="p">,</span> 
        <span class="n">basemodel</span><span class="o">=</span><span class="n">basemodel</span><span class="p">,</span> 
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> 
        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
        <span class="n">r2max</span><span class="o">=</span><span class="n">r2max</span><span class="p">)</span>    
    <span class="k">if</span> <span class="n">newr2max</span> <span class="o">&gt;</span> <span class="n">r2max</span><span class="p">:</span>
        <span class="n">r2max</span> <span class="o">=</span> <span class="n">newr2max</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new r2max, </span><span class="si">{</span><span class="n">feature_max</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">r2max</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;fwd_selection_results.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;a+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new r2max, </span><span class="si">{</span><span class="n">feature_max</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">r2max</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">feature_max</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;canidates.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">file_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">basemodel</span> <span class="o">=</span> <span class="n">newmodel</span>
        <span class="n">basemodel</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;basemodel.csv&quot;</span><span class="p">)</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">X2</span> <span class="o">=</span> <span class="n">basemodel</span><span class="o">.</span><span class="n">values</span>
<span class="n">est</span> <span class="o">=</span> <span class="n">Logit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X2</span><span class="p">)</span>
<span class="n">est2</span> <span class="o">=</span> <span class="n">est</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">summ</span> <span class="o">=</span> <span class="n">est2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">res_table</span> <span class="o">=</span> <span class="n">summ</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_table</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
<span class="n">res_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">res_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">basemodel</span><span class="o">.</span><span class="n">columns</span>
<span class="n">res_df</span>
</code></pre></div>

<h5 id="binary-99th-percentile">Binary, 99<sup>th</sup> Percentile<a class="headerlink" href="#binary-99th-percentile" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="c1">### Create Categories</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">weights</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
<span class="n">lim</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">dom_class_weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">lim</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">quant</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">lim</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">lim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
        <span class="k">continue</span>
    <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">lim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dom_class_weight</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;less than </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> listens&quot;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">labels</span><span class="p">[(</span><span class="n">labels</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">))</span>
              <span class="o">&amp;</span><span class="p">(</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">))]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">weights</span><span class="p">[(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">))</span>
              <span class="o">&amp;</span><span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">))]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> &lt; listens &lt;= </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

    <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">labels</span>

<span class="c1">### Create Training Data</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">des_features</span> <span class="o">+</span> <span class="n">con_features</span><span class="p">]</span>
<span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>

<span class="n">X_cat</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">des_features</span><span class="p">])</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="n">X_con</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">con_features</span><span class="p">])</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X_con</span><span class="p">,</span> <span class="n">X_cat</span><span class="p">))</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">weight_train</span><span class="p">,</span> <span class="n">weight_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="c1">### Train Model</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">weight_train</span><span class="p">)</span>

<span class="c1">### Asses Performance</span>

<span class="n">y_hat_test</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_hat_train</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Acc: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_hat_train</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test Acc: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_hat_test</span><span class="p">),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>

<h2 id="other-metrics">Other Metrics<a class="headerlink" href="#other-metrics" title="Permanent link">&para;</a></h2>
<ul>
<li>30s listens/tot listens (listen conversions) <em>also like a bounce rate</em></li>
<li>Users both months/users prev month (user conversions)<ul>
<li>combine with mau &gt; mau_previous_month</li>
</ul>
</li>
<li>Best small time performers (less than X total monthly listens + high conversion)</li>
<li>Best new user playlist (owner has only 1 popular playlist)</li>
</ul>
<h3 id="listen-and-user-conversions-mau-growing">Listen and User Conversions, MAU Growing<a class="headerlink" href="#listen-and-user-conversions-mau-growing" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="s1">&#39;listen_conversions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stream30s&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;streams&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;listen_conversions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_retention&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau_both_months&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau_previous_month&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_retention&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_conversions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_conversions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau_growing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau_previous_month&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau_growth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau_previous_month&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau_growth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau_growth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">new_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;listen_conversions&#39;</span><span class="p">,</span> <span class="s1">&#39;user_conversions&#39;</span><span class="p">,</span> <span class="s1">&#39;user_retention&#39;</span><span class="p">,</span> <span class="s1">&#39;mau_growth&#39;</span><span class="p">]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="n">new_metrics</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>listen_conversions</th>
      <th>user_conversions</th>
      <th>user_retention</th>
      <th>mau_growth</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>403366.000000</td>
      <td>403366.000000</td>
      <td>403366.000000</td>
      <td>403366.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.334701</td>
      <td>0.724072</td>
      <td>0.571070</td>
      <td>1.513218</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.399968</td>
      <td>0.261708</td>
      <td>0.392073</td>
      <td>17.459669</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>0.020348</td>
      <td>0.000000</td>
      <td>0.031250</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>0.000000</td>
      <td>0.500000</td>
      <td>0.200000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.000000</td>
      <td>0.666667</td>
      <td>0.500000</td>
      <td>1.066667</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.730769</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>7859.000000</td>
    </tr>
  </tbody>
</table>
</div>

<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="s1">&#39;listen_conversions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&lt;AxesSubplot:ylabel=&#39;Frequency&#39;&gt;
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_45_1.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_conversions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&lt;AxesSubplot:ylabel=&#39;Frequency&#39;&gt;
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_46_1.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="s1">&#39;user_retention&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&lt;AxesSubplot:ylabel=&#39;Frequency&#39;&gt;
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_47_1.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau_growth&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">][</span><span class="s1">&#39;mau_growth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&lt;AxesSubplot:ylabel=&#39;Frequency&#39;&gt;
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_48_1.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="s1">&#39;mau_growing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&lt;AxesSubplot:&gt;
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_49_1.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="s1">&#39;new_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">new_metrics</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="s1">&#39;new_success&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>False    362869
True      40497
Name: new_success, dtype: int64
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;new_success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>playlist_uri</th>
      <th>owner</th>
      <th>streams</th>
      <th>stream30s</th>
      <th>dau</th>
      <th>wau</th>
      <th>mau</th>
      <th>mau_previous_month</th>
      <th>mau_both_months</th>
      <th>users</th>
      <th>skippers</th>
      <th>owner_country</th>
      <th>n_tracks</th>
      <th>n_local_tracks</th>
      <th>n_artists</th>
      <th>n_albums</th>
      <th>monthly_stream30s</th>
      <th>monthly_owner_stream30s</th>
      <th>tokens</th>
      <th>genre_1</th>
      <th>genre_2</th>
      <th>genre_3</th>
      <th>mood_1</th>
      <th>mood_2</th>
      <th>mood_3</th>
      <th>listen_conversions</th>
      <th>user_retention</th>
      <th>user_conversions</th>
      <th>mau_growing</th>
      <th>mau_growth</th>
      <th>new_success</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>14</th>
      <td>spotify:user:9a3580868994077be27d244788d494cd:...</td>
      <td>9a3580868994077be27d244788d494cd</td>
      <td>28</td>
      <td>15</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>US</td>
      <td>321</td>
      <td>0</td>
      <td>170</td>
      <td>205</td>
      <td>83</td>
      <td>77</td>
      <td>["sunny", "daze"]</td>
      <td>Alternative</td>
      <td>Indie Rock</td>
      <td>Electronica</td>
      <td>Brooding</td>
      <td>Excited</td>
      <td>Sensual</td>
      <td>0.535714</td>
      <td>1.0</td>
      <td>1.000000</td>
      <td>True</td>
      <td>2.000000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>18</th>
      <td>spotify:user:7abbdbd3119687473b8f2986e73e2ad6:...</td>
      <td>7abbdbd3119687473b8f2986e73e2ad6</td>
      <td>9</td>
      <td>5</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>US</td>
      <td>373</td>
      <td>8</td>
      <td>1</td>
      <td>1</td>
      <td>18</td>
      <td>11</td>
      <td>[]</td>
      <td>Pop</td>
      <td>Alternative</td>
      <td>Indie Rock</td>
      <td>Empowering</td>
      <td>Excited</td>
      <td>Urgent</td>
      <td>0.555556</td>
      <td>1.0</td>
      <td>1.000000</td>
      <td>True</td>
      <td>2.000000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>20</th>
      <td>spotify:user:838141e861005b6a955cb389c19671a5:...</td>
      <td>838141e861005b6a955cb389c19671a5</td>
      <td>32</td>
      <td>25</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
      <td>3</td>
      <td>3</td>
      <td>5</td>
      <td>1</td>
      <td>US</td>
      <td>904</td>
      <td>0</td>
      <td>81</td>
      <td>125</td>
      <td>327</td>
      <td>253</td>
      <td>["metalcore", "forever"]</td>
      <td>Punk</td>
      <td>Metal</td>
      <td>Rock</td>
      <td>Defiant</td>
      <td>Urgent</td>
      <td>Aggressive</td>
      <td>0.781250</td>
      <td>1.0</td>
      <td>0.800000</td>
      <td>True</td>
      <td>1.333333</td>
      <td>True</td>
    </tr>
    <tr>
      <th>36</th>
      <td>spotify:user:2217942070bcaa5f1e651e27744b4402:...</td>
      <td>2217942070bcaa5f1e651e27744b4402</td>
      <td>18</td>
      <td>17</td>
      <td>1</td>
      <td>2</td>
      <td>4</td>
      <td>3</td>
      <td>3</td>
      <td>5</td>
      <td>1</td>
      <td>US</td>
      <td>141</td>
      <td>1</td>
      <td>122</td>
      <td>131</td>
      <td>567</td>
      <td>0</td>
      <td>["chill"]</td>
      <td>Rap</td>
      <td>Dance &amp; House</td>
      <td>Alternative</td>
      <td>Excited</td>
      <td>Defiant</td>
      <td>Energizing</td>
      <td>0.944444</td>
      <td>1.0</td>
      <td>0.800000</td>
      <td>True</td>
      <td>1.333333</td>
      <td>True</td>
    </tr>
    <tr>
      <th>59</th>
      <td>spotify:user:dfde15dd16b4ad87a75036276b4c9f66:...</td>
      <td>dfde15dd16b4ad87a75036276b4c9f66</td>
      <td>5</td>
      <td>5</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>0</td>
      <td>US</td>
      <td>84</td>
      <td>0</td>
      <td>73</td>
      <td>78</td>
      <td>254</td>
      <td>239</td>
      <td>["vegas"]</td>
      <td>Rock</td>
      <td>Pop</td>
      <td>R&amp;B</td>
      <td>Upbeat</td>
      <td>Excited</td>
      <td>Empowering</td>
      <td>1.000000</td>
      <td>1.0</td>
      <td>0.666667</td>
      <td>True</td>
      <td>2.000000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>403329</th>
      <td>spotify:user:358b83239c6a2557fbfb053330d49a41:...</td>
      <td>358b83239c6a2557fbfb053330d49a41</td>
      <td>4</td>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>0</td>
      <td>US</td>
      <td>33</td>
      <td>0</td>
      <td>28</td>
      <td>31</td>
      <td>271</td>
      <td>32</td>
      <td>["one", "dirt", "road"]</td>
      <td>Country &amp; Folk</td>
      <td>Rock</td>
      <td>-</td>
      <td>Yearning</td>
      <td>Empowering</td>
      <td>Gritty</td>
      <td>1.000000</td>
      <td>1.0</td>
      <td>1.000000</td>
      <td>True</td>
      <td>3.000000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>403336</th>
      <td>spotify:user:a0781a2de47beb8bd693f3022f316327:...</td>
      <td>a0781a2de47beb8bd693f3022f316327</td>
      <td>856</td>
      <td>855</td>
      <td>3</td>
      <td>10</td>
      <td>10</td>
      <td>5</td>
      <td>5</td>
      <td>10</td>
      <td>0</td>
      <td>US</td>
      <td>168</td>
      <td>0</td>
      <td>6</td>
      <td>9</td>
      <td>33747</td>
      <td>1391</td>
      <td>["evning", "song"]</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>0.998832</td>
      <td>1.0</td>
      <td>1.000000</td>
      <td>True</td>
      <td>2.000000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>403338</th>
      <td>spotify:user:06f6dd666f1bbf9148c792b87ed4d22f:...</td>
      <td>06f6dd666f1bbf9148c792b87ed4d22f</td>
      <td>5</td>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>US</td>
      <td>59</td>
      <td>0</td>
      <td>34</td>
      <td>46</td>
      <td>21</td>
      <td>9</td>
      <td>["rhc"]</td>
      <td>Religious</td>
      <td>Pop</td>
      <td>Alternative</td>
      <td>Empowering</td>
      <td>Upbeat</td>
      <td>Brooding</td>
      <td>0.800000</td>
      <td>1.0</td>
      <td>1.000000</td>
      <td>True</td>
      <td>2.000000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>403348</th>
      <td>spotify:user:c6af258245d55221cebedb1175f08d83:...</td>
      <td>c6af258245d55221cebedb1175f08d83</td>
      <td>13</td>
      <td>11</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>US</td>
      <td>31</td>
      <td>0</td>
      <td>30</td>
      <td>29</td>
      <td>208</td>
      <td>206</td>
      <td>["zumba", "val", "silva", "playlist"]</td>
      <td>Latin</td>
      <td>Pop</td>
      <td>Dance &amp; House</td>
      <td>Aggressive</td>
      <td>Excited</td>
      <td>Defiant</td>
      <td>0.846154</td>
      <td>1.0</td>
      <td>1.000000</td>
      <td>True</td>
      <td>2.000000</td>
      <td>True</td>
    </tr>
    <tr>
      <th>403353</th>
      <td>spotify:user:5461b6b460dd512d7b4fd4fb488f3520:...</td>
      <td>5461b6b460dd512d7b4fd4fb488f3520</td>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>US</td>
      <td>146</td>
      <td>0</td>
      <td>115</td>
      <td>123</td>
      <td>405</td>
      <td>321</td>
      <td>["myfavorites"]</td>
      <td>Indie Rock</td>
      <td>Electronica</td>
      <td>Alternative</td>
      <td>Yearning</td>
      <td>Energizing</td>
      <td>Brooding</td>
      <td>1.000000</td>
      <td>1.0</td>
      <td>1.000000</td>
      <td>True</td>
      <td>2.000000</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>40497 rows  31 columns</p>
</div>

<div class="codehilite"><pre><span></span><code><span class="n">chidf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;new_success&#39;</span>
<span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
<span class="c1"># quant_value = 0.90</span>
<span class="c1"># tar_value = np.quantile(chidf[target], quant_value)</span>
<span class="c1"># chidf[target] = chidf[target] &gt; tar_value</span>
<span class="n">chisum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">pop</span> <span class="o">=</span> <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">des_features</span><span class="p">:</span>
    <span class="c1"># ind = des_features[0]</span>
    <span class="n">chidf</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">grp_label</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="c1"># grp_label = df[ind].unique()[0]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cTable</span> <span class="o">=</span> <span class="n">chidf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="n">grp_label</span><span class="p">)[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2_contingency</span><span class="p">(</span><span class="n">cTable</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">cTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">cTable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">chisum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">chisum</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">ind</span><span class="p">,</span> <span class="n">grp_label</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cTable</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">p</span><span class="o">&lt;</span><span class="n">cutoff</span><span class="p">]])])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="n">chisum</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">,</span> <span class="s1">&#39;p-value&#39;</span><span class="p">,</span> <span class="s1">&#39;cTable&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="s1">&#39;reject null&#39;</span><span class="p">]</span>
<span class="n">chisum</span> <span class="o">=</span> <span class="n">chisum</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;p-value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">chisum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;reject null&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature</th>
      <th>group</th>
      <th>chi</th>
      <th>p-value</th>
      <th>cTable</th>
      <th>multiplier</th>
      <th>reject null</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6</th>
      <td>genre_1</td>
      <td>Dance &amp; House</td>
      <td>231.225731</td>
      <td>3.221322e-52</td>
      <td>[[334768, 28101], [36487, 4010]]</td>
      <td>1.309267</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>genre_1</td>
      <td>Indie Rock</td>
      <td>386.328998</td>
      <td>5.212769e-86</td>
      <td>[[300809, 62060], [31986, 8511]]</td>
      <td>1.289733</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>mood_1</td>
      <td>Excited</td>
      <td>289.821405</td>
      <td>5.438394e-65</td>
      <td>[[306376, 56493], [32871, 7626]]</td>
      <td>1.258184</td>
      <td>True</td>
    </tr>
    <tr>
      <th>4</th>
      <td>mood_1</td>
      <td>Defiant</td>
      <td>285.014998</td>
      <td>6.064223e-64</td>
      <td>[[291222, 71647], [31065, 9432]]</td>
      <td>1.234123</td>
      <td>True</td>
    </tr>
    <tr>
      <th>16</th>
      <td>genre_2</td>
      <td>Electronica</td>
      <td>124.733558</td>
      <td>5.820843e-29</td>
      <td>[[335186, 27683], [36772, 3725]]</td>
      <td>1.226540</td>
      <td>True</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>70</th>
      <td>mood_1</td>
      <td>Somber</td>
      <td>30.852148</td>
      <td>2.784538e-08</td>
      <td>[[361994, 875], [40456, 41]]</td>
      <td>0.419270</td>
      <td>True</td>
    </tr>
    <tr>
      <th>0</th>
      <td>genre_3</td>
      <td>-</td>
      <td>1404.327669</td>
      <td>2.410008e-307</td>
      <td>[[324633, 38236], [38610, 1887]]</td>
      <td>0.414947</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>genre_2</td>
      <td>-</td>
      <td>861.809401</td>
      <td>1.968786e-189</td>
      <td>[[342541, 20328], [39619, 878]]</td>
      <td>0.373430</td>
      <td>True</td>
    </tr>
    <tr>
      <th>24</th>
      <td>mood_1</td>
      <td>Other</td>
      <td>81.806778</td>
      <td>1.500630e-19</td>
      <td>[[361232, 1637], [40439, 58]]</td>
      <td>0.316494</td>
      <td>True</td>
    </tr>
    <tr>
      <th>42</th>
      <td>genre_1</td>
      <td>Spoken &amp; Audio</td>
      <td>58.779116</td>
      <td>1.764037e-14</td>
      <td>[[361755, 1114], [40460, 37]]</td>
      <td>0.296965</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>101 rows  7 columns</p>
</div>

<div class="codehilite"><pre><span></span><code><span class="n">chisum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;reject null&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature</th>
      <th>group</th>
      <th>chi</th>
      <th>p-value</th>
      <th>cTable</th>
      <th>multiplier</th>
      <th>reject null</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>42</th>
      <td>genre_1</td>
      <td>Spoken &amp; Audio</td>
      <td>58.779116</td>
      <td>1.764037e-14</td>
      <td>[[361755, 1114], [40460, 37]]</td>
      <td>0.296965</td>
      <td>True</td>
    </tr>
    <tr>
      <th>24</th>
      <td>mood_1</td>
      <td>Other</td>
      <td>81.806778</td>
      <td>1.500630e-19</td>
      <td>[[361232, 1637], [40439, 58]]</td>
      <td>0.316494</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>genre_2</td>
      <td>-</td>
      <td>861.809401</td>
      <td>1.968786e-189</td>
      <td>[[342541, 20328], [39619, 878]]</td>
      <td>0.373430</td>
      <td>True</td>
    </tr>
    <tr>
      <th>0</th>
      <td>genre_3</td>
      <td>-</td>
      <td>1404.327669</td>
      <td>2.410008e-307</td>
      <td>[[324633, 38236], [38610, 1887]]</td>
      <td>0.414947</td>
      <td>True</td>
    </tr>
    <tr>
      <th>70</th>
      <td>mood_1</td>
      <td>Somber</td>
      <td>30.852148</td>
      <td>2.784538e-08</td>
      <td>[[361994, 875], [40456, 41]]</td>
      <td>0.419270</td>
      <td>True</td>
    </tr>
    <tr>
      <th>73</th>
      <td>genre_1</td>
      <td>Easy Listening</td>
      <td>30.613123</td>
      <td>3.149562e-08</td>
      <td>[[361984, 885], [40455, 42]]</td>
      <td>0.424642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>40</th>
      <td>mood_2</td>
      <td>-</td>
      <td>60.796108</td>
      <td>6.330294e-15</td>
      <td>[[361087, 1782], [40411, 86]]</td>
      <td>0.431224</td>
      <td>True</td>
    </tr>
    <tr>
      <th>43</th>
      <td>mood_1</td>
      <td>-</td>
      <td>57.600397</td>
      <td>3.211607e-14</td>
      <td>[[361161, 1708], [40414, 83]]</td>
      <td>0.434269</td>
      <td>True</td>
    </tr>
    <tr>
      <th>37</th>
      <td>mood_3</td>
      <td>-</td>
      <td>64.489845</td>
      <td>9.703118e-16</td>
      <td>[[360957, 1912], [40404, 93]]</td>
      <td>0.434536</td>
      <td>True</td>
    </tr>
    <tr>
      <th>48</th>
      <td>genre_1</td>
      <td>Children's</td>
      <td>52.188042</td>
      <td>5.043231e-13</td>
      <td>[[361298, 1571], [40420, 77]]</td>
      <td>0.438111</td>
      <td>True</td>
    </tr>
    <tr>
      <th>32</th>
      <td>mood_1</td>
      <td>Easygoing</td>
      <td>72.784800</td>
      <td>1.445861e-17</td>
      <td>[[360451, 2418], [40371, 126]]</td>
      <td>0.465255</td>
      <td>True</td>
    </tr>
    <tr>
      <th>56</th>
      <td>mood_3</td>
      <td>Serious</td>
      <td>43.083601</td>
      <td>5.245004e-11</td>
      <td>[[361404, 1465], [40420, 77]]</td>
      <td>0.469948</td>
      <td>True</td>
    </tr>
    <tr>
      <th>59</th>
      <td>genre_2</td>
      <td>Other</td>
      <td>41.614387</td>
      <td>1.111721e-10</td>
      <td>[[361446, 1423], [40422, 75]]</td>
      <td>0.471283</td>
      <td>True</td>
    </tr>
    <tr>
      <th>82</th>
      <td>mood_2</td>
      <td>Other</td>
      <td>25.423296</td>
      <td>4.603257e-07</td>
      <td>[[361970, 899], [40449, 48]]</td>
      <td>0.477800</td>
      <td>True</td>
    </tr>
    <tr>
      <th>60</th>
      <td>genre_1</td>
      <td>Traditional</td>
      <td>39.228043</td>
      <td>3.770852e-10</td>
      <td>[[361402, 1467], [40416, 81]]</td>
      <td>0.493733</td>
      <td>True</td>
    </tr>
    <tr>
      <th>39</th>
      <td>genre_3</td>
      <td>Easy Listening</td>
      <td>61.357952</td>
      <td>4.758655e-15</td>
      <td>[[360552, 2317], [40368, 129]]</td>
      <td>0.497272</td>
      <td>True</td>
    </tr>
    <tr>
      <th>47</th>
      <td>genre_2</td>
      <td>Easy Listening</td>
      <td>53.106215</td>
      <td>3.159911e-13</td>
      <td>[[360858, 2011], [40385, 112]]</td>
      <td>0.497648</td>
      <td>True</td>
    </tr>
    <tr>
      <th>65</th>
      <td>mood_2</td>
      <td>Stirring</td>
      <td>34.226638</td>
      <td>4.905289e-09</td>
      <td>[[361548, 1321], [40423, 74]]</td>
      <td>0.501033</td>
      <td>True</td>
    </tr>
    <tr>
      <th>57</th>
      <td>mood_1</td>
      <td>Serious</td>
      <td>42.044137</td>
      <td>8.923632e-11</td>
      <td>[[361247, 1622], [40406, 91]]</td>
      <td>0.501590</td>
      <td>True</td>
    </tr>
    <tr>
      <th>10</th>
      <td>genre_1</td>
      <td>Soundtrack</td>
      <td>169.038371</td>
      <td>1.200050e-38</td>
      <td>[[356345, 6524], [40127, 370]]</td>
      <td>0.503642</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">)</span>

<span class="n">ind_feature</span> <span class="o">=</span> <span class="s1">&#39;genre_1&#39;</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;new_success&#39;</span>

<span class="n">genre_list</span> <span class="o">=</span> <span class="n">chisum</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ind_feature</span><span class="p">)</span>
                       <span class="o">&amp;</span> <span class="p">(</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;reject null&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>



<span class="n">chisum</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ind_feature</span><span class="p">)</span>
                       <span class="o">&amp;</span> <span class="p">(</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;reject null&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s1">&#39;table2.xlsx&#39;</span><span class="p">)</span>

<span class="n">dff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">ind_feature</span><span class="p">])[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">dff</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;percent&#39;</span><span class="p">]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
<span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">ind_feature</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">genre_list</span><span class="p">,:]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">10</span><span class="p">,:],</span> <span class="n">hue</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ind_feature</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Best  and Worst Genres, Percent&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:,:],</span> <span class="n">hue</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ind_feature</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># ax[1,0].set_title(&#39;Worst Primary Genres&#39;)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">dff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">ind_feature</span><span class="p">])[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">dff</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="c1"># dff.loc[dff[target] == True, &#39;percent&#39;] = dff.loc[dff[target] == True, &#39;percent&#39;] / dff.loc[dff[target] == True, &#39;percent&#39;].sum() </span>
<span class="c1"># dff.loc[dff[target] == False, &#39;percent&#39;] = dff.loc[dff[target] == False, &#39;percent&#39;] / dff.loc[dff[target] == False, &#39;percent&#39;].sum() </span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">ind_feature</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">genre_list</span><span class="p">,:]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># fix, ax = plt.subplots(2, 2, figsize=(10,10))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">10</span><span class="p">,:],</span> <span class="n">hue</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ind_feature</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Best and Worst Genres, Count&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:,:],</span> <span class="n">hue</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ind_feature</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># ax[1,1].set_title(&#39;Worst Primary Genres&#39;)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">framealpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Success&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;new_categorical_dependency.svg&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_56_0.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">)</span>
<span class="n">ind_feature</span> <span class="o">=</span> <span class="s1">&#39;mood_1&#39;</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;new_success&#39;</span>

<span class="n">genre_list</span> <span class="o">=</span> <span class="n">chisum</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ind_feature</span><span class="p">)</span>
                       <span class="o">&amp;</span> <span class="p">(</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;reject null&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">chisum</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ind_feature</span><span class="p">)</span>
                       <span class="o">&amp;</span> <span class="p">(</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;reject null&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s1">&#39;table.xlsx&#39;</span><span class="p">)</span>

<span class="n">dff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">ind_feature</span><span class="p">])[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">dff</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;percent&#39;</span><span class="p">]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
<span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">ind_feature</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">genre_list</span><span class="p">,:]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">10</span><span class="p">,:],</span> <span class="n">hue</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ind_feature</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Best  and Worst Genres, Percent&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:,:],</span> <span class="n">hue</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ind_feature</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># ax[1,0].set_title(&#39;Worst Primary Genres&#39;)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">dff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">ind_feature</span><span class="p">])[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">dff</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="c1"># dff.loc[dff[target] == True, &#39;percent&#39;] = dff.loc[dff[target] == True, &#39;percent&#39;] / dff.loc[dff[target] == True, &#39;percent&#39;].sum() </span>
<span class="c1"># dff.loc[dff[target] == False, &#39;percent&#39;] = dff.loc[dff[target] == False, &#39;percent&#39;] / dff.loc[dff[target] == False, &#39;percent&#39;].sum() </span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">ind_feature</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">genre_list</span><span class="p">,:]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># fix, ax = plt.subplots(2, 2, figsize=(10,10))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">10</span><span class="p">,:],</span> <span class="n">hue</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ind_feature</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Best and Worst Genres, Count&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:,:],</span> <span class="n">hue</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ind_feature</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># ax[1,1].set_title(&#39;Worst Primary Genres&#39;)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">framealpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Success&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;new_categorical_dependency_mood.svg&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_57_0.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">con_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n_albums&#39;</span><span class="p">,</span> <span class="s1">&#39;n_artists&#39;</span><span class="p">,</span> <span class="s1">&#39;n_tracks&#39;</span><span class="p">,</span> <span class="s1">&#39;n_local_tracks&#39;</span><span class="p">]</span>
<span class="n">chidf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;new_success&quot;</span>
<span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
<span class="n">welchsum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">pop</span> <span class="o">=</span> <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">con_features</span><span class="p">,</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">]):</span>
    <span class="n">chidf</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">boot1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="n">chidf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="p">][</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                    <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">boot2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="n">chidf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="p">][</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                    <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot1</span><span class="p">))</span>
        <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot2</span><span class="p">))</span>
    <span class="n">testt</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">a_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">welchsum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">welchsum</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">ind</span><span class="p">,</span> <span class="n">testt</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">a_avg</span><span class="p">,</span> <span class="n">b_avg</span><span class="p">,</span> <span class="n">p</span><span class="o">&lt;</span><span class="n">cutoff</span><span class="p">]])])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> == True&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> == False&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>

<span class="n">welchsum</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;test stat&#39;</span><span class="p">,</span> <span class="s1">&#39;p-value&#39;</span><span class="p">,</span> <span class="s1">&#39;upper q avg&#39;</span><span class="p">,</span> <span class="s1">&#39;lower q avg&#39;</span><span class="p">,</span> <span class="s1">&#39;reject null&#39;</span><span class="p">]</span>
<span class="n">welchsum</span> <span class="o">=</span> <span class="n">welchsum</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;p-value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">welchsum</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">&quot;new_ttest.xlsx&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;new_ttest.svg&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_58_0.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="n">chidf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
<span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
<span class="c1"># chidf.iloc[:int(chidf.shape[0]/2),:] = True</span>
<span class="c1"># chidf.iloc[int(chidf.shape[0]/2):,:] = False</span>
<span class="c1"># quant_value = 0.99</span>
<span class="c1"># tar_value = np.quantile(chidf[target], quant_value)</span>
<span class="c1"># chidf[target] = chidf[target] &gt; tar_value</span>
<span class="n">welchsum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">pop</span> <span class="o">=</span> <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">con_features</span><span class="p">:</span>
    <span class="c1"># ind = con_features[0]</span>
    <span class="n">chidf</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="c1"># for grp_label in df[ind].unique():</span>
    <span class="c1"># try:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">boot1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="n">chidf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="p">][</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                    <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">boot2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="n">chidf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="p">][</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                    <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot1</span><span class="p">))</span>
        <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot2</span><span class="p">))</span>
    <span class="n">testt</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">a_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">welchsum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">welchsum</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">ind</span><span class="p">,</span> <span class="n">testt</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">a_avg</span><span class="p">,</span> <span class="n">b_avg</span><span class="p">,</span> <span class="n">p</span><span class="o">&lt;</span><span class="n">cutoff</span><span class="p">]])])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> == True&quot;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> == False&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="c1"># except:</span>
    <span class="c1">#     pass</span>

<span class="n">welchsum</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;test stat&#39;</span><span class="p">,</span> <span class="s1">&#39;p-value&#39;</span><span class="p">,</span> <span class="s1">&#39;upper q avg&#39;</span><span class="p">,</span> <span class="s1">&#39;lower q avg&#39;</span><span class="p">,</span> <span class="s1">&#39;reject null&#39;</span><span class="p">]</span>
<span class="n">welchsum</span> <span class="o">=</span> <span class="n">welchsum</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;p-value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<h3 id="considering-outliers">Considering outliers<a class="headerlink" href="#considering-outliers" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">targets</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;owner&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;spotify&#39;</span><span class="p">]</span>
</code></pre></div>

<h3 id="multiple-criteria-for-success">Multiple Criteria for Success<a class="headerlink" href="#multiple-criteria-for-success" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">sub_targets</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">chidf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;success&#39;</span>
<span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
<span class="c1"># quant_value = 0.90</span>
<span class="c1"># tar_value = np.quantile(chidf[target], quant_value)</span>
<span class="c1"># chidf[target] = chidf[target] &gt; tar_value</span>
<span class="n">chisum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">pop</span> <span class="o">=</span> <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">des_features</span><span class="p">:</span>
    <span class="c1"># ind = des_features[0]</span>
    <span class="n">chidf</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">grp_label</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="c1"># grp_label = df[ind].unique()[0]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cTable</span> <span class="o">=</span> <span class="n">chidf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="n">grp_label</span><span class="p">)[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2_contingency</span><span class="p">(</span><span class="n">cTable</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">cTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">cTable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">chisum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">chisum</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">ind</span><span class="p">,</span> <span class="n">grp_label</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cTable</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">p</span><span class="o">&lt;</span><span class="n">cutoff</span><span class="p">]])])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="n">chisum</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">,</span> <span class="s1">&#39;p-value&#39;</span><span class="p">,</span> <span class="s1">&#39;cTable&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="s1">&#39;reject null&#39;</span><span class="p">]</span>
<span class="n">chisum</span> <span class="o">=</span> <span class="n">chisum</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;p-value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">chisum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;reject null&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">)</span>

<span class="n">genre_list</span> <span class="o">=</span> <span class="n">chisum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chisum</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;genre_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;genre_1&#39;</span><span class="p">])[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">dff</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;percent&#39;</span><span class="p">]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
<span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dff</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;genre_1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">genre_list</span><span class="p">,:]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">10</span><span class="p">,:],</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;genre_1&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Best  and Worst Genres, Percent&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:,:],</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;genre_1&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># ax[1,0].set_title(&#39;Worst Primary Genres&#39;)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">dff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;genre_1&#39;</span><span class="p">])[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">dff</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="c1"># dff.loc[dff[&#39;success&#39;] == True, &#39;percent&#39;] = dff.loc[dff[&#39;success&#39;] == True, &#39;percent&#39;] / dff.loc[dff[&#39;success&#39;] == True, &#39;percent&#39;].sum() </span>
<span class="c1"># dff.loc[dff[&#39;success&#39;] == False, &#39;percent&#39;] = dff.loc[dff[&#39;success&#39;] == False, &#39;percent&#39;] / dff.loc[dff[&#39;success&#39;] == False, &#39;percent&#39;].sum() </span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;genre_1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">genre_list</span><span class="p">,:]</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># fix, ax = plt.subplots(2, 2, figsize=(10,10))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">10</span><span class="p">,:],</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;genre_1&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Best and Worst Genres, Count&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:,:],</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;genre_1&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># ax[1,1].set_title(&#39;Worst Primary Genres&#39;)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">framealpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Success&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;categorical_dependency.svg&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">ind</span> <span class="o">=</span> <span class="s1">&#39;n_tracks&#39;</span>
<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;wau&#39;</span>
<span class="n">mean_wau_vs_track</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">201</span><span class="p">):</span>
    <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">boot</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> 
                            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="n">track</span><span class="p">)</span>
                        <span class="p">][</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                    <span class="n">k</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> 
                            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="n">track</span><span class="p">)</span>
                        <span class="p">][</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span> <span class="mi">1000</span><span class="p">))</span>
        <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot</span><span class="p">))</span>
    <span class="n">mean_wau_vs_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">means</span><span class="p">))</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mean_wau_vs_track</span><span class="p">)),</span> <span class="n">mean_wau_vs_track</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="c1"># ax.set_ylim(0,5)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> 
                            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="n">track</span><span class="p">)</span>
                        <span class="p">][</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</code></pre></div>

<h3 id="dependency">Dependency<a class="headerlink" href="#dependency" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">master</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">new_metrics</span><span class="p">:</span>
    <span class="c1"># target = sub_targets[0]</span>
    <span class="n">chidf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
    <span class="n">quant_value</span> <span class="o">=</span> <span class="mf">0.90</span>
    <span class="n">tar_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">quant_value</span><span class="p">)</span>
    <span class="n">tar_value</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tar_value</span>
    <span class="n">chisum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.0001</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">des_features</span><span class="p">:</span>
        <span class="c1"># ind = des_features[0]</span>
        <span class="n">chidf</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">grp_label</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="c1"># grp_label = df[ind].unique()[0]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cTable</span> <span class="o">=</span> <span class="n">chidf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="n">grp_label</span><span class="p">)[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2_contingency</span><span class="p">(</span><span class="n">cTable</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">cTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">cTable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">chisum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">chisum</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">target</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">grp_label</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cTable</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">p</span><span class="o">&lt;</span><span class="n">cutoff</span><span class="p">]])])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">chisum</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">,</span> <span class="s1">&#39;p-value&#39;</span><span class="p">,</span> <span class="s1">&#39;cTable&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="s1">&#39;reject null&#39;</span><span class="p">]</span>
    <span class="n">chisum</span> <span class="o">=</span> <span class="n">chisum</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;p-value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># chisum = chisum.loc[(chisum[&#39;reject null&#39;] == True) &amp; (chisum[&#39;multiplier&#39;] &gt; 2)].sort_values(&#39;multiplier&#39;, ascending=False)</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">master</span><span class="p">,</span> <span class="n">chisum</span><span class="p">))</span>

<span class="n">master</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">master</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">master</span><span class="p">[</span><span class="s1">&#39;reject null&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">master</span><span class="p">[</span><span class="s1">&#39;multiplier&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">)]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">master</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">master</span><span class="p">[</span><span class="s1">&#39;reject null&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">master</span><span class="p">[</span><span class="s1">&#39;multiplier&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">.5</span><span class="p">)]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">new_master</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">new_metrics</span><span class="p">:</span>
    <span class="c1"># target = sub_targets[2]</span>
    <span class="n">chidf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
    <span class="n">chidf</span><span class="p">[</span><span class="s1">&#39;n_tracks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;n_tracks&#39;</span><span class="p">]</span>
    <span class="n">quant_value</span> <span class="o">=</span> <span class="mf">0.90</span>
    <span class="n">tar_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">quant_value</span><span class="p">)</span>
    <span class="n">tar_value</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tar_value</span>
    <span class="n">welchsum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">cutoff</span> <span class="o">=</span> <span class="mf">0.0001</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">con_features</span><span class="p">:</span>
        <span class="c1"># ind = con_features[0]</span>
        <span class="n">chidf</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="c1"># for grp_label in df[ind].unique():</span>
        <span class="c1"># try:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="n">boot1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                        <span class="nb">list</span><span class="p">(</span>
                            <span class="n">chidf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                <span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
                                <span class="o">&amp;</span> <span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="s1">&#39;n_tracks&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
                                <span class="o">&amp;</span> <span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="s1">&#39;n_tracks&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">999</span><span class="p">)</span>
                            <span class="p">][</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                        <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">boot2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                        <span class="nb">list</span><span class="p">(</span>
                            <span class="n">chidf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                                <span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="o">&amp;</span> <span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="s1">&#39;n_tracks&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
                                <span class="o">&amp;</span> <span class="p">(</span><span class="n">chidf</span><span class="p">[</span><span class="s1">&#39;n_tracks&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">999</span><span class="p">)</span>
                            <span class="p">][</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                        <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot1</span><span class="p">))</span>
            <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot2</span><span class="p">))</span>
        <span class="n">testt</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">a_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">b_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">welchsum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">welchsum</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">target</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">testt</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">a_avg</span><span class="p">,</span> <span class="n">b_avg</span><span class="p">,</span> <span class="n">p</span><span class="o">&lt;</span><span class="n">cutoff</span><span class="p">]])])</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">tar_value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">tar_value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="c1"># except:</span>
        <span class="c1">#     pass</span>

    <span class="n">welchsum</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;test stat&#39;</span><span class="p">,</span> <span class="s1">&#39;p-value&#39;</span><span class="p">,</span> <span class="s1">&#39;upper q avg&#39;</span><span class="p">,</span> <span class="s1">&#39;lower q avg&#39;</span><span class="p">,</span> <span class="s1">&#39;reject null&#39;</span><span class="p">]</span>
    <span class="n">welchsum</span> <span class="o">=</span> <span class="n">welchsum</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;p-value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new_master</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">new_master</span><span class="p">,</span> <span class="n">welchsum</span><span class="p">))</span>
<span class="n">new_master</span>
</code></pre></div>

<h2 id="conclusions">Conclusions<a class="headerlink" href="#conclusions" title="Permanent link">&para;</a></h2>
<h3 id="discrete-independent-variables">Discrete, Independent Variables<a class="headerlink" href="#discrete-independent-variables" title="Permanent link">&para;</a></h3>
<p>We note that there is class imbalance in the discrete independent variables:</p>
<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">dff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">des_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">des_features</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">des_features</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()))</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="n">dff</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mood&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;mood&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">dff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">des_features</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">des_features</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">des_features</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()))</span>
<span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="n">dff</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;genre&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dff</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;genre&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div>

<p>This class imbalance can have a variety of effects (and might be derived from a variety of sources).</p>
<p>For example, users will have more choice when listening to popular genres likeIndie Rock and Rap, and less choice with genres like Blues and Easy listening. As it so happens, when we look to the relationship between genre/mood and the dependent variables, many of the genre/moods with smaller class sizes will have a positive multiplier effect on the dependent variable</p>
<h3 id="continuous-independent-variables">Continuous, Independent Variables<a class="headerlink" href="#continuous-independent-variables" title="Permanent link">&para;</a></h3>
<p>The four continuous variables of focus in this dataset are highly tailed. Due to this, our statistical tests will require bootstrapping.</p>
<div class="codehilite"><pre><span></span><code><span class="n">quant</span> <span class="o">=</span> <span class="mf">0.999</span>
<span class="n">con_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n_albums&#39;</span><span class="p">,</span> <span class="s1">&#39;n_artists&#39;</span><span class="p">,</span> <span class="s1">&#39;n_tracks&#39;</span><span class="p">,</span> <span class="s1">&#39;n_local_tracks&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">con_features</span><span class="p">:</span>
    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">quant</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">]</span>
    <span class="n">removed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">)]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;removed items: </span><span class="si">{</span><span class="n">removed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>removed items: 404
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_81_1.png" /></p>
<div class="codehilite"><pre><span></span><code>removed items: 405
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_81_3.png" /></p>
<div class="codehilite"><pre><span></span><code>removed items: 404
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_81_5.png" /></p>
<div class="codehilite"><pre><span></span><code>removed items: 406
</code></pre></div>

<p><img alt="png" src="../X3_Spotify-Copy1_files/X3_Spotify-Copy1_81_7.png" /></p>
<p>an example of bootstrapping <code>n_albums</code></p>
<div class="codehilite"><pre><span></span><code><span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ind</span> <span class="o">=</span> <span class="n">con_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">boot</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> 
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">999</span><span class="p">)</span>
                    <span class="p">][</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                <span class="n">k</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot</span><span class="p">))</span>
<span class="n">stuff</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<h3 id="discrete-dependent-variables">Discrete, Dependent Variables<a class="headerlink" href="#discrete-dependent-variables" title="Permanent link">&para;</a></h3>
<p>For the purposes of investigating a "successful" playlist, there are 5 primary metrics:</p>
<div class="codehilite"><pre><span></span><code><span class="n">targets</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="n">sub_targets</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">&quot;file.xlsx&quot;</span><span class="p">)</span>
</code></pre></div>

<p>and "top" performers in each of these metrics were based on top 10% and top 1% quantiles:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p99 targets&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">sub_targets</span><span class="p">:</span>
    <span class="n">space</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">*</span> <span class="p">(</span><span class="mi">20</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="mf">0.99</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p90 targets&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">sub_targets</span><span class="p">:</span>
    <span class="n">space</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">*</span> <span class="p">(</span><span class="mi">20</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="mf">0.90</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>You can imagine with these metrics, some concerns are:</p>
<ul>
<li>what if a playlist was made in the current month, or even current day?<ul>
<li>playlist is not properly represented by the data</li>
</ul>
</li>
<li>how do we normalize by playlists that already have a high visibility? i.e. what if a playlist is "good" but just isn't getting noticed?<ul>
<li>can compute conversion metrics:<ul>
<li>30 second listens / total listens</li>
<li>mau both months / mau previous month</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>While noting these shortcomings, to keep the analysis focused I singled out the previously mentioned targets, with a focus on <code>monthly_stream30s</code> as the north star metric. <code>monthly_stream30s</code> is advantageous as a nort star metric since it contains data from the entire month (reducing variance) only contains relevant listens (greater than 30 seconds long). Some disadvantages of this metric are that it doesn't account for just a few listeners who may be providing the majority of listens, and playlists that were made in the current month will be undervalued.</p>
<h3 id="dependency_1">Dependency<a class="headerlink" href="#dependency_1" title="Permanent link">&para;</a></h3>
<h4 id="chi-square">Chi Square<a class="headerlink" href="#chi-square" title="Permanent link">&para;</a></h4>
<p>In the chi-square test, the contigency table was used to calculate a <code>multiplier</code> effect. This is a ratio of ratios: the count of upper quantile over bottom quantile for the given group over the count of upper quantile over bottom quantile for non-group. In other words, it articulates how much more likely a sample in the given group is likely to be in the upper quantile vs a sample not in the given group</p>
<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;chi_square_results.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">chisq_results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;upper q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</code></pre></div>

<p>Taking together the five targets, the two upper quantiles, and the six categorical independent variables, we can identify which group occured the most frequently as a variable of influence:</p>
<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;genre&#39;</span><span class="p">))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">)][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div>

<p>Using these value counts as a "rank" we can then groupby this rank and see how each group is influencing the propensity to be in the upper quadrant</p>
<p>Taking "Romantic" as an example, we see that it's multiplier effect is relatively consistent across the five targets and two quantiles:</p>
<div class="codehilite"><pre><span></span><code><span class="n">sort_key</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()))}</span>
<span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sort_key</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="n">chisq_results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># chisq_results.drop(&#39;rank&#39;, axis=1, inplace=True)</span>
<span class="n">chisq_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">][:</span><span class="mi">20</span><span class="p">]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Traditional&#39;</span><span class="p">)</span>
                 <span class="o">&amp;</span> <span class="p">(</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;monthly_stream30s&#39;</span><span class="p">)]</span>
</code></pre></div>

<p>Let's use this idea of average multiplier effect, and average chi-square statistic to summarize by group.</p>
<p>Sorting by the test statistic, we see the top 5 most influential groups:</p>
<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)[[</span><span class="s1">&#39;chi&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;chi&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</code></pre></div>

<p>Sorting instead by the multiplier, we can see which group has the <em>heaviest</em> influence</p>
<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)[[</span><span class="s1">&#39;chi&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</code></pre></div>

<p>Sorting instead by rank, we see which groups show up most frequently</p>
<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)[[</span><span class="s1">&#39;chi&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplier&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;monthly_stream30s&#39;</span><span class="p">]</span>
</code></pre></div>

<p>It creates some fog to jumble together mood/genres this way. We can instead separate them and ask questions like:</p>
<h5 id="what-is-the-most-influential-primary-genre-on-monthly-streams-over-30-seconds">What is the most influential primary genre on monthly streams over 30 seconds?<a class="headerlink" href="#what-is-the-most-influential-primary-genre-on-monthly-streams-over-30-seconds" title="Permanent link">&para;</a></h5>
<p>Answer: Children's followed by Latin</p>
<p>Reason: both genre's appear as influential in other guardrail metrics (high rank), have high test statistics, and are influential in both p99 and p90 with multiplier effects of [4.8, 2.6] and [3.1, 2.1], respectively.</p>
<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;genre_1&#39;</span><span class="p">)</span>
                 <span class="o">&amp;</span> <span class="p">(</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;monthly_stream30s&#39;</span><span class="p">)]</span>
</code></pre></div>

<h5 id="what-is-the-most-influential-primary-mood-on-monthly-streams-over-30-seconds">What is the most influential primary mood on monthly streams over 30 seconds?<a class="headerlink" href="#what-is-the-most-influential-primary-mood-on-monthly-streams-over-30-seconds" title="Permanent link">&para;</a></h5>
<p>Answer: Romantic and Lively</p>
<p>Reason: Romantic and Lively moods appear multiple times as highly influential (high rank) they have high multipliers. A contendent may be Tender, as it has a high multiplier effect as well at 3.75</p>
<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mood_1&#39;</span><span class="p">)</span>
                 <span class="o">&amp;</span> <span class="p">(</span><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;monthly_stream30s&#39;</span><span class="p">)]</span>
</code></pre></div>

<h5 id="which-categorical-feature-is-most-influential-overall">Which Categorical Feature is most influential overall?<a class="headerlink" href="#which-categorical-feature-is-most-influential-overall" title="Permanent link">&para;</a></h5>
<p>Answer: genre_1, followed by genre_2 and mood_1</p>
<p>Reason: we see that these features appear multiple times across the 5 different targets and 2 different quantiles</p>
<div class="codehilite"><pre><span></span><code><span class="n">chisq_results</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div>

<h5 id="what-are-the-shortcomings-of-this-analysis">What are the shortcomings of this analysis?<a class="headerlink" href="#what-are-the-shortcomings-of-this-analysis" title="Permanent link">&para;</a></h5>
<p>We haven't taken into account confounding variables. For example, perhaps Latin genre is typically associated with Lively mood. Then which variable is it that actually contributes to a highly performing playlist? We have strategies for dealing with this. We can stratify the confounding variables by over or under sampling. We can also consider them together in a forward selection logistic model. We will take the latter approach later on in the analysis.</p>
<p>We haven't considered the categorical variables alongside the continuous variables, so we don't know how they fit overall in terms of relative improtance. We will approach this the same way as the confounding variables issue, and incorporate all variables in a logistic regression.</p>
<h4 id="t-test">t-Test<a class="headerlink" href="#t-test" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="n">ttest_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;t_test_results.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ttest_results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>

<h4 id="models">Models<a class="headerlink" href="#models" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="n">log_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../../scripts/fwd_selection_results.txt&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">log_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;pseudo r2&#39;</span><span class="p">]</span>
<span class="n">log_results</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">log_results</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">log_results</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;monthly_stream30s&quot;</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">weights</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span>
<span class="n">lim</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">dom_class_weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">lim</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">quant</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">lim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">lim</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">lim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
        <span class="k">continue</span>
    <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">lim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dom_class_weight</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;less than </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> listens&quot;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">labels</span><span class="p">[(</span><span class="n">labels</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">))</span>
              <span class="o">&amp;</span> <span class="p">(</span><span class="n">labels</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">weights</span><span class="p">[(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">))</span>
              <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">))]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> &lt; listens &lt;= </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">quant</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">quant</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">labels</span>

<span class="n">basemodel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../../scripts/basemodel.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">X2</span> <span class="o">=</span> <span class="n">basemodel</span><span class="o">.</span><span class="n">values</span>
<span class="n">est</span> <span class="o">=</span> <span class="n">Logit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X2</span><span class="p">)</span>
<span class="n">est2</span> <span class="o">=</span> <span class="n">est</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">summ</span> <span class="o">=</span> <span class="n">est2</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">res_table</span> <span class="o">=</span> <span class="n">summ</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_table</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
<span class="n">res_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">res_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">basemodel</span><span class="o">.</span><span class="n">columns</span>
<span class="n">res_df</span>
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 Wesley Beckner
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.361d90f1.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.289a2a4b.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>